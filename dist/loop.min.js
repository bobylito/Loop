/*! loop 2013-08-22 */
var a=function(){var a=Date.now(),b=a,c=0,d=1e3,e=0,f=0,g=1e3,h=0,i=0,j=0,k=document.createElement("div");k.id="stats",k.addEventListener("mousedown",function(a){a.preventDefault(),s(++j%2)},!1),k.style.cssText="width:80px;opacity:0.9;cursor:pointer";var l=document.createElement("div");l.id="fps",l.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",k.appendChild(l);var m=document.createElement("div");m.id="fpsText",m.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",m.innerHTML="FPS",l.appendChild(m);var n=document.createElement("div");for(n.id="fpsGraph",n.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",l.appendChild(n);74>n.children.length;){var o=document.createElement("span");o.style.cssText="width:1px;height:30px;float:left;background-color:#113",n.appendChild(o)}var p=document.createElement("div");p.id="ms",p.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",k.appendChild(p);var q=document.createElement("div");q.id="msText",q.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",q.innerHTML="MS",p.appendChild(q);var r=document.createElement("div");for(r.id="msGraph",r.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",p.appendChild(r);74>r.children.length;)o=document.createElement("span"),o.style.cssText="width:1px;height:30px;float:left;background-color:#131",r.appendChild(o);var s=function(a){switch(j=a){case 0:l.style.display="block",p.style.display="none";break;case 1:l.style.display="none",p.style.display="block"}};return{domElement:k,setMode:s,begin:function(){a=Date.now()},end:function(){var j=Date.now();c=j-a,d=Math.min(d,c),e=Math.max(e,c),q.textContent=c+" MS ("+d+"-"+e+")";var k=Math.min(30,30-30*(c/200));return r.appendChild(r.firstChild).style.height=k+"px",i++,j>b+1e3&&(f=Math.round(1e3*i/(j-b)),g=Math.min(g,f),h=Math.max(h,f),m.textContent=f+" FPS ("+g+"-"+h+")",k=Math.min(30,30-30*(f/100)),n.appendChild(n.firstChild).style.height=k+"px",b=j,i=0),j},update:function(){a=this.end()}}};window.jsPlot=function(a,b,c){var d=Math.log(10),e={extend:c,createCanvas:function(a,c){var d=b.getElementById(a),e=d.getElementsByTagName("canvas")[0];return e||(e=b.createElement("canvas"),d.appendChild(e)),e.width=c.canvasWidth,e.height=c.canvasHeight,e.getContext("2d")},findNiceRoundStep:function(a,b){var c=a/b,e=Math.floor(Math.log(c)/d),f=Math.pow(10,e),c=c/f;return 1.5>c?c=1:3.5>c?c=2:7.5>c?c=5:(f=Math.pow(10,e+1),c=1),c*f},drawAxes:function(a,b){a.save(),a.strokeStyle="#888",a.beginPath(),a.moveTo(b.Xmin*b.xscale,0),a.lineTo(b.Xmax*b.xscale,0),a.moveTo(0,b.Ymin*b.yscale),a.lineTo(0,b.Ymax*b.yscale),a.stroke(),a.fillStyle="black",a.beginPath(),a.moveTo(b.Xmax*b.xscale,0),a.lineTo(b.Xmax*b.xscale-10,6),a.lineTo(b.Xmax*b.xscale-10,-6),a.lineTo(b.Xmax*b.xscale,0),a.moveTo(0,b.Ymax*b.yscale),a.lineTo(-6,b.Ymax*b.yscale-10),a.lineTo(6,b.Ymax*b.yscale-10),a.lineTo(0,b.Ymax*b.yscale),a.fill(),a.scale(-1,1),a.font="13px helvetica",a.textAlign="end",a.textBaseline="bottom",a.rotate(Math.PI),a.save(),a.translate(b.Xmax*b.xscale-13,-2),a.fillText(b.xLabel,0,0),a.restore(),a.rotate(-Math.PI/2),a.translate(b.Ymax*b.yscale-13,-2),a.fillText(b.yLabel,0,0),a.restore()},drawGrid:function(a,b){var c=e.findNiceRoundStep(b.Xmax-b.Xmin,15);a.save(),a.font="15px helvetica",a.strokeStyle="#CCF",a.lineWidth=1,a.beginPath();for(var d=b.Xmin-b.Xmin%c;d<b.Xmax;d+=c)a.moveTo(d*b.xscale,b.Ymin*b.yscale),a.lineTo(d*b.xscale,b.Ymax*b.yscale);for(a.stroke(),a.beginPath(),d=b.Ymin-b.Ymin%c;d<b.Ymax;d+=c)a.moveTo(b.Xmin*b.xscale,d*b.yscale),a.lineTo(b.Xmax*b.xscale,d*b.yscale);for(a.stroke(),a.save(),a.rotate(-Math.PI),a.scale(-1,1),d=b.Xmin-b.Xmin%(2*c);d<b.Xmax;d+=2*c)a.fillText(Math.round(1e6*d)/1e6,d*b.xscale,0);for(a.rotate(-Math.PI/2),d=b.Ymin-b.Ymin%(2*c);d<b.Ymax;d+=2*c){var f=Math.round(1e6*d)/1e6;0!==f&&a.fillText(f,d*b.yscale,0)}a.restore(),a.restore()},drawFunction:function(a,b,c){try{var d=b.Xmin*b.xscale,e=b.Xmax*b.xscale,f=a.strokeStyle,g=c.color?c.color:"#000";for(a.lineWidth=c.width?c.width:1,a.strokeStyle=g,a.moveTo(d,c(d)),a.beginPath();e>=d;d++){var h=c(d/b.xscale),h=h<b.Ymin?b.Ymin-1:h,h=h>b.Ymax?b.Ymax+1:h;a.lineTo(d,h*b.yscale)}a.stroke()}catch(i){}finally{a.stokeStyle=f}}},f={Xmin:0,Xmax:10,Ymin:0,Ymax:3,xLabel:"x",yLabel:"y",canvasHeight:500,canvasWidth:500,gridVisible:!0},a=function(a,b,c){var b=e.extend({},f,b),d=b.X=b.Xmax-b.Xmin,g=b.Y=b.Ymax-b.Ymin,d=b.xscale=b.canvasWidth/d,g=b.yscale=b.canvasHeight/g,a=e.createCanvas(a,b);for(a.scale(1,-1),a.translate(0,-b.canvasHeight),a.translate(-(b.Xmin*d),-(b.Ymin*g)),b.gridVisible&&e.drawGrid(a,b),e.drawAxes(a,b),d=0;d<c.length;d++)e.drawFunction(a,b,c[d])};return a.tools={datasetToFunc:function(a){return a.reduce(function(a,b,c,d){if(c=d[c+1],void 0===c)return function(c){return c>b[0]?void 0:a(c)};var e=(c[1]-b[1])/(c[0]-b[0]),f=b[1]-e*b[0],g=b[0];return function(b){return b>=g?e*b+f:a(b)}},function(){})},funcToDataset:function(a,b){for(var c=e.findNiceRoundStep(b.Xmax-b.Xmin,15),d=[],f=b.Xmin-b.Xmin%c;f<b.Xmax;f+=c)d.push(a(f));return d}},a}(window,document,function(a){return[].slice.call(arguments,1).forEach(function(b){for(key in b)a[key]=b[key]}),a}),window.Loop=function(){function a(a,b){this.eventRegister={},this._animations=[],this._io=[],this.canvas=a||document.createElement("canvas"),this.canvasOff=function(a,b){return a.height=b.height,a.width=b.width,a}(document.createElement("canvas"),this.canvas),this.ctx=this.canvas.getContext("2d"),this.ctxOff=this.canvasOff.getContext("2d"),this.height=a.height,this.width=a.width,this.fadeoutf=b||function(){this.ctxOff.globalCompositeOperation="source-over",this.ctxOff.fillStyle="#000000",this.ctxOff.fillRect(0,0,this.width,this.height)},this.status=null,this.stats=function(){var a=new c;return a.domElement&&(a.domElement.style.position="absolute",a.domElement.style.right="0px",a.domElement.style.top="0px",document.body.appendChild(a.domElement)),a}(),this.loop=this.loop.bind(this)}var b=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),c=c||function(){this.setMode=function(){},this.begin=function(){},this.end=function(){}};return a.prototype={loop:function(){var a=this.calculateIOState();this.fadeoutf(this.ctxOff,this.width,this.height),this.stats.begin(),this._animations.forEach(function(a){a.render(this.ctxOff,this.width,this.height)},this),this.ctx.drawImage(this.canvasOff,0,0);for(var c=this._animations.length-1;c>=0;c--)this._animations[c].animate(a,this.width,this.height)||this._animations.splice(c,1);this.stats.end(),this.status&&b(this.loop)},start:function(){this._trigger("start"),this.fadeoutf(this.ctxOff,this.width,this.height),this.status=!0,this.loop()},stop:function(){this._trigger("stop"),this.status=!1},registerAnimation:function(a){"function"==typeof a._init&&a._init(this.width,this.height,this,this.calculateIOState()),this._animations.push(a)},addIO:function(a){a._init(this.canvas),this._io.push(a)},calculateIOState:function(){return this._io.map(function(a){return a.update}).reduce(function(a,b){return b(a)},{})},on:function(a,b){void 0===this.eventRegister[a]&&(this.eventRegister[a]=[]),this.eventRegister[a].push(b)},_trigger:function(a){if(this.eventRegister[a]){var b=this;this.eventRegister[a].forEach(function(a){a.call(b)})}}},a.animations={},a}(),window.loop=new Loop(document.getElementById("scene")),window.Loop.animations.bench=function(){return function(){var a=document.createElement("div");return a.innerHTML=0,document.body.appendChild(a),{_init:function(a,b,c){var d=this;c.on("start",function(){d.pf=c._animations.filter(function(a){return!!a.getParticleCount})})},animate:function(){return!0},render:function(){a.innerHTML=this.pf.reduce(function(a,b){return a+b.getParticleCount()},0)}}}}(),Loop.io=function(){function a(a,b){this.update=a.bind(this),this.variables=b}a.prototype={_init:function(a){this.el=a,this.elPos=a.getBoundingClientRect()}};var b=function(b){var c=new a(function(a){return a.keys=this._currentKeys(),a});c._keys={},c._inversedConfig={};for(k in b)c._keys[k]=!1,c._inversedConfig[b[k]]=k;return c._currentKeys=function(){return document.addEventListener("keydown",function(a){var b=a.keyCode;b in c._inversedConfig&&(c._keys[c._inversedConfig[b]]=!0)}),document.addEventListener("keyup",function(a){var b=a.keyCode;b in c._inversedConfig&&(c._keys[c._inversedConfig[b]]=!1)}),c._currentKeys=function(){return this._keys},this._keys},c},c=function(){var b=new a(function(a){var b=this._positionValue();return a.position={x:b.x?b.x-this.elPos.left:b.x,y:b.y?b.y-this.elPos.top:b.y},a},["position"]);return b._positionValue=function(){var a=this;return this.el.addEventListener("mousemove",function(b){a._position={x:b.pageX,y:b.pageY}}),this.el.addEventListener("mouseout",function(){a._position={x:null,y:null}}),this._positionValue=function(){return this._position},this._position={x:null,y:null},this._position},b},d=new a(function(a){return a.time=Date.now(),a},["time"]),e=function(b){var c=new a(function(a){return a.time=this._timeValue(),a},["time"]);return c._timeValue=function(){return this._el=function(a){var c=document.createElement("input");return c.setAttribute("type","range"),c.setAttribute("min","0"),c.setAttribute("max",b),c.addEventListener("change",function(){a._time=parseInt(this.value,10)}),document.body.appendChild(c),c.value=0,a._time=0,c}(this),this._timeValue=function(){return this._time},this._time},c};return{mouse:c,time:d,keyboard:b,controlTime:e}}(),function(){var a=function(){var a=document.createElement("div");return a.id="debugData",document.body.appendChild(a),{_out:a,_messages:[],_init:function(a,b,c){var d=this;if(c.debug){var e=c.debug;c.debug=function(a,b){e(a,b),d._messages.push([a,b])}}else c.debug=function(a,b){d._messages.push([a,b])}},animate:function(){return!0},render:function(){var a=this._messages.sort(function(a,b){return a[0].localeCompare(b[0])});this._out.innerHTML=a.reduce(function(a,b){return a+b[0]+" : "+b[1]+"<br/>"},""),this._messages=[]}}},b=function(){var a=document.createElement("script");a.type="text/javascript",a.src="http://localhost:7000/plot.js",document.body.appendChild(a);var b=document.createElement("div");b.id="debugGraph",document.body.appendChild(b);var c=["hsl(0, 66%, 30%)","hsl(40, 66%, 30%)","hsl(80, 66%, 30%)","hsl(120, 66%, 30%)","hsl(160, 66%, 30%)"];return{_messages:[],_dataSets:{},lastT:0,originalT:0,_init:function(a,b,c,d){var e=this;if(this.originalT=d.time,c.debug){var f=c.debug;c.debug=function(a,b){f(a,b),e._messages.push([a,b])}}else c.debug=function(a,b){e._messages.push([a,b])}},render:function(){if(window.jsPlot){var a=function(a){var b,d=[],e=0;for(b in a){var f=a[b],g=jsPlot.tools.datasetToFunc(f);g.color=c[e++%c.length],d.push(g)}return d}(this._dataSets),b=(this.lastT-this.originalT)/10,d=function(a,b){var c;for(c in a){var d=a[c],e=d[0][0];b>e&&(b=e)}return b}(this._dataSets,b);jsPlot("debugGraph",{Xmin:d,Xmax:b,Ymin:-10,Ymax:10,canvasHeight:250,canvasWidth:500,gridVisible:!1},a)}},animate:function(a){var b=this._dataSets;if(a.time>this.lastTime+1e3)return!0;var c=this.lastT-this.originalT;this.lastT=a.time;var d=this.asNumber;return this._messages.forEach(function(a){var e=a[0],f=d(a[1]);void 0!==f&&(b[e]||(b[e]=[]),b[e].length>=200&&b[e].shift(),b[e].push([c/10,f]))}),this._messages=[],!0},asNumber:function(a){if("number"==typeof a)return a;if("string"==typeof a)try{var b=parseFloat(a);return 0/0===b?void 0:b}catch(c){return void 0}return void 0}}};Loop.tools={debug:a,debugGraph:b}}(),Loop.meta=function(){var a=function(){if(arguments.length<1)throw new Error("andThen must have at least one animation");var a=Array.prototype.slice.call(arguments,0);return{_init:function(){this.current=a.shift(),this.current._init.apply(this.current,arguments)},animate:function(b,c,d){var e=this.current.animate.apply(this.current,arguments);if(!e){if(!(a.length>0))return!1;var f=function(a){return a.result&&"function"==typeof a.result?a.result():void 0}(this.current);this.current=a.shift(),this.current._init(c,d,loop,b,f)}return!0},render:function(){this.current.render.apply(this.current,arguments)}}},b=function(){if(arguments.length<1)throw new Error("all must have at least 1 animation");return{animations:Array.prototype.slice.call(arguments,0),_init:function(){var a=arguments;this.animations.forEach(function(b){b._init&&"function"==typeof b._init&&b._init.apply(b,a)})},render:function(){var a=arguments;this.animations.forEach(function(b){b.render.apply(b,a)})},animate:function(){var a=arguments;return this.animations=this.animations.reduce(function(b,c){var d=c.animate.apply(c,a);return d&&b.push(c),b},[]),this.animations.length>0}}};return{andThen:a,all:b}}(),function(){function a(a){this.render=a}var b={circle:function(a,b){var c=a.size/2;this.particleCanvas||(this.particleCanvas=function(){var b=document.createElement("canvas"),d=b.getContext("2d");return b.width=a.size,b.height=a.size,d.fillStyle=a.color,d.beginPath(),d.arc(c,c,c,0,2*Math.PI,!0),d.closePath(),d.fill(),b}()),b.globalCompositeOperation=a.compositionMethod;for(var d=0;d<this.particles.length;d++){var e=this.particles[d];b.drawImage(this.particleCanvas,~~(e[0]-c),~~(e[1]-c))}},texture:function(a,b){for(var c=0;c<this.particles.length;c++){var d=this.particles[c];b.drawImage(a.img,~~d[0],~~d[1])}},line:function(a,b){if(0!==this.particles.length){b.globalCompositeOperation=a.compositionMethod,b.beginPath(),b.strokeStyle=a.color,b.moveTo(~~this.particles[0][0],~~this.particles[0][1]);for(var c=1;c<this.particles.length;c++){var d=this.particles[c];b.lineTo(~~d[0],~~d[1])}b.stroke()}},quadratic:function(a,b){if(0!==this.particles.length){b.globalCompositeOperation=a.compositionMethod,b.beginPath(),b.strokeStyle=a.color,b.moveTo(~~this.particles[0][0],~~this.particles[0][1]);for(var c=1;c<this.particles.length;c++){var d=this.particles[c];b.quadraticCurveTo(d[0]-100*d[3],d[1]-100*d[4],~~d[0],~~d[1])}b.stroke()}},imageData:function(a,b,c,d){for(var e=b.getImageData(0,0,c,d),f=e.data,g=1;g<this.particles.length;g++){var h=this.particles[g],i=~~h[0],j=~~h[1],k=4*(i+j*c);f[k]=250,f[k+1]=250,f[k+2]=2,f[k+3]=255}b.putImageData(e,0,0)}};a.prototype={createField:function(a,b,c,d,e){var f=e||function(){},g={_init:function(b,c){this.width=b,this.height=c,this.particles=a?a(b,c):[],this.toBeCreated=[]},animate:function(a,b,d){this.toBeCreated.forEach(function(b){this._create(a,b)},this),this.toBeCreated=[];for(var e=0;e<this.particles.length;e++){var g=this.particles[e],h=a.time;c(g,this.particles,b,d,a),g[0]=g[0]+g[3],g[1]=g[1]+g[4],(g[0]>b+500||g[1]>d+500||g[0]<-500||g[1]<-500||g[2]<h)&&(f(g),this.particles.splice(e,1))}return!0},create:function(a){this.toBeCreated.push(a)},_create:function(a,b){Date.now();for(var c=0;b>c;c++)this.particles.push(this._createParticlef(a,this.width,this.height))},getParticleCount:function(){return this.particles.length}};return g.render=this.render.bind(g,d),g._createParticlef=b,g}};var c=new a(b.circle),d=new a(b.line),e=new a(b.quadratic),f=new a(b.texture),g=new a(b.imageData);window.Loop.animations.particle=c.createField.bind(c),window.Loop.animations.particleLasso=d.createField.bind(d),window.Loop.animations.particleLasso2=e.createField.bind(e),window.Loop.animations.particleTexture=f.createField.bind(f),window.Loop.animations.particleImageData=g.createField.bind(g)}(window),Loop.text=function(){var a=function(a,b){return{_init:function(a,b,c,d){this.startTime=d.time},animate:function(a){return a.time<this.startTime+b},render:function(b,c,d){var e=b.measureText(a);b.fillStyle="white",b.fillText(a,c/2-e.width/2,d/2)}}},b=function(a){var b="loading";return{resources:a,loaded:{},totalLoad:0,total:0,_init:function(){a.data&&(this.total+=a.data.length,a.data.forEach(function(a){var b=new XMLHttpRequest,c=this;b.addEventListener("load",function(){c.loaded[a]=JSON.parse(this.response),c.totalLoad++}),b.open("GET",a,!0),b.send()},this)),a.img&&(this.total+=a.img.length,a.img.forEach(function(a){var b=document.createElement("img"),c=this;b.addEventListener("load",function(){c.loaded[a]=b,c.totalLoad++}),b.src=a},this))},animate:function(){return this.total>this.totalLoad},render:function(a,c,d){var e=a.measureText(b);a.fillStyle="white",a.fillText(b,c/2-e.width/2,d/2)},result:function(){return this.loaded}}};return{simple:a,loading:b}}();