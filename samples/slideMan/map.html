<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Map sample</title>
</head>
<body>
	
  <canvas id="scene" height=500 width=500></canvas>
  <script src="../../Stats.js" type="text/javascript"></script>
  <script src="../../lib.js" type="text/javascript" language="javascript" charset="utf-8"></script>
  <script src="../../io.js" type="text/javascript" language="javascript" charset="utf-8"></script>
  <script src="../../meta.js" type="text/javascript" language="javascript" charset="utf-8"></script>
  <script src="../../text.js" type="text/javascript" language="javascript" charset="utf-8"></script>
  <script src="../../particles.js" type="text/javascript" language="javascript" charset="utf-8"></script>

  <script type="text/javascript">
(function(){
  var loading = Loop.text.loading({
    img : ["../ouno.png", "textureMap.png"],
    data : ["map.json"]
  });

  var m = cameraMap();
  var c = character();
  var game = Loop.meta.all( m, c); 

  loop.registerAnimation(Loop.meta.andThen(loading, game));

  loop.addIO(Loop.io.keyboard({"UP":38,"DOWN":40,"LEFT":37,"RIGHT":39,"SPACE":32}) );
  loop.start();

  function character(){
    return {
      pos     : {
        x : 4,
        y : 95
      },
      _init : function(w, h, sys, ioState, resources){
        this.sprite = resources["../ouno.png"];
      },
      render  : function(ctx, w, h){
        ctx.drawImage(this.sprite, w/2, h/2);
      },
      animate : function(ioState, w, h){
        return true; 
      }
    };
  }

  //pattern application in an animation
  function cameraMap( mapData, texture ){
    return {
      pos : {
        x :  4,
        y : 95
      },
      _init : function(w,h,sys,ioState, resources){
        var mapData = this.mapData = resources["map.json"];
        this.texture = resources["textureMap.png"];
        this.txH = mapData.tileheight;
        this.txW = mapData.tilewidth ;
        //FIXME : get resources
      },
      render : function(ctx, width, height){
        var xIt = Math.ceil( width / this.txW ),
            yIt = Math.ceil( height/ this.txH );

        var naturalPos = {
          x : Math.floor(this.pos.x),
          y : Math.floor(this.pos.y)
        };

        var devPos = {
          x : this.pos.x - Math.floor(this.pos.x),
          y : this.pos.y - Math.floor(this.pos.y)
        };

        var translatePos = naturalPos.y * this.mapData.layers[0].width + naturalPos.x;
        var mapWidth = this.mapData.layers[0].width;

        for( i = -1; i < xIt + 1; i++){
          for( j = -1; j < yIt + 1; j++){
            var dataPos = translatePos + i + j * mapWidth,
                imgX = Math.floor(dataPos / mapWidth) != (j + naturalPos.y)  ? -1 : this.mapData.layers[0].data[ dataPos ] - 1,
                imgY = 0;
            ctx.drawImage(this.texture, imgX * this.txW, imgY * this.txH, 
                                   this.txW, this.txH, 
                                   (i - devPos.x) * this.txW, 
                                   (j - devPos.y) * this.txH, 
                                   this.txW , 
                                   this.txH );
          }
        }
      },
      animate: function(ioState, width, height){ 
        if(ioState.keys.LEFT)  this.pos.x -= 0.1;
        if(ioState.keys.RIGHT) this.pos.x += 0.1;
        if(ioState.keys.UP)    this.pos.y -= 0.1;
        if(ioState.keys.DOWN)  this.pos.y += 0.1;
        return true; 
      }
    };
  }
})();
  </script>
</body>
</html>
